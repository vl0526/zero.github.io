<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thumbnail Extractor</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #111; color: #fff; }
        button, input { padding: 10px; margin: 10px; cursor: pointer; border: none; font-size: 16px; }
        button { background: #00aaff; color: #fff; }
        #thumbnails img { width: 100px; margin: 5px; }
        #bestThumbnail { max-width: 640px; display: none; margin-top: 20px; }
        #downloadLink { display: none; color: #00ffcc; font-size: 18px; text-decoration: none; }
    </style>
</head>
<body>
    <h2>Trích Xuất & Chọn Thumbnail Đẹp Nhất</h2>
    <input type="file" id="videoInput" accept="video/*">
    <button onclick="extractThumbnails()">Bắt Đầu</button>
    <div id="thumbnails"></div>
    <h3>Ảnh Đẹp Nhất:</h3>
    <img id="bestThumbnail">
    <a id="downloadLink" download="best_thumbnail.jpg">Tải Ảnh Đẹp Nhất</a>

    <script>
        function extractThumbnails() {
            let file = document.getElementById("videoInput").files[0];
            if (!file) return alert("Chọn video trước!");
            let video = document.createElement("video"), canvas = document.createElement("canvas"), ctx = canvas.getContext("2d");
            video.src = URL.createObjectURL(file);
            video.muted = true;
            video.play();
            video.addEventListener("loadedmetadata", () => {
                let duration = Math.min(video.duration, 150), times = [], count = 0;
                for (let t = 0; t < duration && count < 30; t += 30, count++) times.push(t);
                captureFrames(video, times, canvas, ctx);
            });
        }

        function captureFrames(video, times, canvas, ctx) {
            let thumbs = document.getElementById("thumbnails"), images = [];
            thumbs.innerHTML = "";
            canvas.width = 1280; canvas.height = 720;
            let index = 0;

            function captureNext() {
                if (index >= times.length) return findBestThumbnail(images);
                video.currentTime = times[index];
                video.addEventListener("seeked", function snap() {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    let img = new Image();
                    img.src = canvas.toDataURL("image/jpeg");
                    img.style.margin = "8px";
                    thumbs.appendChild(img);
                    images.push(img.src);
                    video.removeEventListener("seeked", snap);
                    index++;
                    captureNext();
                });
            }
            captureNext();
        }

        async function findBestThumbnail(images) {
            let bestImage = images[0], bestScore = 0;
            for (let img of images) {
                let score = await analyzeImage(img);
                if (score > bestScore) [bestImage, bestScore] = [img, score];
            }
            document.getElementById("bestThumbnail").src = bestImage;
            document.getElementById("bestThumbnail").style.display = "block";
            let link = document.getElementById("downloadLink");
            link.href = bestImage;
            link.style.display = "block";
        }

        async function analyzeImage(imageSrc) {
            let img = new Image();
            img.src = imageSrc;
            await img.decode();
            let tensor = tf.browser.fromPixels(img).mean().dataSync()[0];
            return tensor;
        }
    </script>
</body>
</html>
